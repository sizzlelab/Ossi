<html>
	<head>
		<title>OssiTesterWidget</title>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<!-- jQuery -->
		<script language="javascript" type="text/javascript" src="libs/jquery-1.3.2.min.js"></script>
		<!-- JsUnit -->
		<script language='JavaScript' type='text/javascript' src='libs/jsunit/app/jsUnitCore.js'></script>
		<!-- COS module -->
		<script language='JavaScript' type='text/javascript' src='libs/cos.js' ></script>
	</head>
		
		<iframe id='iframe' name='iframe' src='../v1/index.html' frameborder='0'  ></iframe>
		
		<div id='data' >
			<p>OSSI Tester</p>
			<button id='start'>Start testing</button>
		</div>
		
		<script type='text/javascript'>
			$('#start').click( function() {
				this.temp = 10;
			} );

			testCase();
			var TRANSACTION_DELAY = 4000; // wait 4 secs between transactions
			var COS_ID = 'dLRfOwt7qr3QtLaaWPEYjL';
			
			// TODO: could this be mase syncronous
			function waitForTransaction(f){
				setTimeout( f ,TRANSACTION_DELAY );
			}
			
			var temp = 0;
			function testCase() { 
				scope = top.iframe.document;
				if( scope.URL == "about:blank" | scope.URL == '' | this.temp < 6 ) {		
					this.temp++;
					// FIXME: this is a bit ugly
					setTimeout( function(){
						testCase();
               				} , TRANSACTION_DELAY );
					return;
				}

				alert('We are go!');
				// login
				scope.getElementById( 'username' ).value = 'tester';
				scope.getElementById( 'password' ).value = 'tester';
				scope.getElementById( 'login_button' ).onclick();
				// $( '#username', scope).val('tester');
				waitForTransaction( function(){
				// test main menu content
               			x = scope.getElementById('mainmenupane').childElements();
				assertEquals( 'Main component should have 8 elements' , 8 , x.length );
				assertEquals( 'Name should be tester' , 'tester' , scope.getElementById('mainmenu_profile_name').innerHTML );
				// test that user has friend
				scope.getElementById('friends_button').onclick();
				waitForTransaction( function() {
				friend = scope.getElementById( 'friend_uid_link_biPssKjrCr3PQyaaWPEYjL' );
				assertEquals('Matti should be a friend', 'Matti Nelimarkka' , friend.innerHTML.match('Matti Nelimarkka')[0] );
				// update status via API request
				var test_input = Math.ceil( Math.random() * 10000000 )
				var me = cos.user.get_user( COS_ID );
				cos.user.post_user( me, { 'person[status_message]' : test_input }  )
				scope.getElementById( 'friend_list_back_button' ).onclick();
				waitForTransaction( function(){
				// verify we are in the main menu
				x = scope.getElementById( 'mainmenupane' ).childElements();
				assertEquals('Main component should have 8 elements', 8, x.length);
				// verify that API request has been updated into the view
				assertEquals('View of status not updated' , '' + test_input , scope.getElementById('mainmenu_status_text').innerHTML );
				// test status update via OSSI
				scope.getElementById('microblog_button').onclick();
				waitForTransaction( function(){
				test_input = Math.ceil( Math.random() * 10000000 );
				scope.getElementById('status_textarea').value = test_input;
				// TODO: FIXME
				try {
					scope.getElementById('done_button').onclick();
				} catch( e ) {

				}
				waitForTransaction( function(){
				me = cos.user.get_user( COS_ID );
				assertEquals( 'Status should have been updated', me.self.status.message , '' + test_input );
				// testing channels
				scope.getElementById('channels_button').onclick();
				waitForTransaction( function() {
				// look the page where channel is
				channel_found = false;
				while( ! channel_found ) {
					channel = scope.getElementById('channel_id_bNcEjsuAer3PsHaaWPEYjL');
					// ("div:contains('Ossi Tester Channel')", scope);
					if( channel.innerHTML != null ) {
						channel_found = true;
					} else {
						scope.getElementById('channels_next_button').onclick();
						// this should sleep for some time
						for( i = 0; i < 10000; i++ ) {
							// HACK
							sum = i;
						}
					}							
				}
				scope.getElementById('channel_id_bNcEjsuAer3PsHaaWPEYjL').onclick();
				waitForTransaction( function () {
				scope.getElementById('add_post_button').onclick();			
				waitForTransaction( function () {
				test_input = Math.ceil( Math.random() * 10000000 );
				scope.getElementById('post_message').value = test_input;
				// todo: should include API tests if API is modified
				scope.getElementById('save_post_button').onclick();
				waitForTransaction( function() {
				scope.getElementById('ok_button' ).onclick();
				waitForTransaction( function() {
				found = scope.getElementsByClassName('post_button')[0].innerHTML.match(test_input);
				// found = $('.post_button:first', scope).html().match(test_input);
				assertNotNull( 'There should be new message', found );
				scope.getElementById('channel_back_button').onclick();
				waitForTransaction( function() {
				scope.getElementById('channels_back_button').onclick();
				} );
				} );
				} );
				} );	
				} );
				} );
				} );
				} );
				} );
				} );
               	} );
				
			}
		</script>
		
	</body>
</html>
