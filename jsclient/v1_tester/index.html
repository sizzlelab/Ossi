<html>
	<head>
		<title>OssiTesterWidget</title>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<!-- jQuery -->
		<script language="javascript" type="text/javascript" src="libs/jquery-1.3.2.min.js"></script>
		<script language="JavaScript" type="text/javascript" src="libs/jQuery.frameReady.js"></script>
		<!-- JsUnit -->
		<script language='JavaScript' type='text/javascript' src='libs/jsunit/app/jsUnitCore.js'></script>
		<!-- COS module -->
		<script language='JavaScript' type='text/javascript' src='libs/cos.js' ></script>
	</head>
		
		<iframe id='iframe' name='iframe' src='../v1/index.html' frameborder='0'  ></iframe>
		
		<div id='data' >
			<p>OSSI Tester</p>
		</div>
		
		<script type='text/javascript'>
			$.frameReady( testCase(), 'top.iframe', { remote: true} );
			var TRANSACTION_DELAY = 4000; // wait 4 secs between transactions
			var COS_ID = 'dLRfOwt7qr3QtLaaWPEYjL';
			
			// TODO: could this be mase syncronous
			function waitForTransaction(f){
				setTimeout( f ,TRANSACTION_DELAY );
			}
			
			function testCase() { 
				scope = top.iframe.document;
				if( scope.URL == "about:blank" ) {
					// scope failed
					// FIXME: this is a bit ugly
					setTimeout(
					function(){
               			alert('Please wait...');
						testCase();
               		} ,
						TRANSACTION_DELAY
					);
					return;
				}

				// login
				$( '#username', scope).val('tester');
				$( '#password', scope ).val('tester');
				$( '#login_button', scope ).click();
				waitForTransaction( function(){
				// test main menu content
               	x = $('#mainmenupane', scope).contents();
				assertEquals( 'Main component should have 17 elements' , 17 , x.length );
				assertEquals( 'Name should be tester' , 'tester' , $('#mainmenu_profile_name', scope).html() );
				// test that user has friend
				$('#friends_button' , scope).click();
				waitForTransaction( function() {
				assertEquals('Matti should be a friend', 1, $('#friend_uid_link_biPssKjrCr3PQyaaWPEYjL', scope).length )
				// update status via API request
				var test_input = Math.ceil( Math.random() * 10000000 )
				var me = cos.user.get_user( COS_ID );
				cos.user.post_user( me, { 'person[status_message]' : test_input }  )
				$('#friend_list_back_button', scope).click();
				waitForTransaction( function(){
				// verify we are in the main menu
				x = $('#mainmenupane', scope).contents();
				assertEquals('Main component should have 17 elements', 17, x.length);
				// verify that API request has been updated into the view
				assertEquals('View of status not updated' , '' + test_input , $('#mainmenu_status_text', scope).html() );
				// test status update via OSSI
				$('#mainmenu_status_text', scope).click();
				waitForTransaction( function(){
				test_input = Math.ceil( Math.random() * 10000000 )
				$('#status_textarea', scope).val( test_input );
				$('#done_button', scope).click();
				waitForTransaction( function(){
				me = cos.user.get_user( COS_ID );
				assertEquals( 'Status should have been updated', me.self.status.message , '' + test_input );
				// testing channels
				$('#channels_button', scope).click();
				waitForTransaction( function() {
				// look the page where channel is
				channel_found = false;
				while( ! channel_found ) {
					channels = $("div:contains('Ossi Tester Channel')", scope);
					if( channels.length > 0 ) {
						channel_found = true;
					} else {
						$('#channels_next_button', scope).click();
						// this should sleep for some time
						for( i = 0; i < 10000; i++ ) {
							// HACK
							sum = i;
						}
					}							
				}
				$('#channel_id_bNcEjsuAer3PsHaaWPEYjL', scope).click();
				waitForTransaction( function () {
				$('#add_post_button' , scope ).click();			
				waitForTransaction( function () {
				test_input = Math.ceil( Math.random() * 10000000 );
				$('#post_message', scope).val( test_input );
				// todo: should include API tests if API is modified
				$('#save_post_button' , scope ).click();
				waitForTransaction( function() {
				$('#ok_button', scope).click();
				waitForTransaction( function() {
				found = $('.post_button:first', scope).html().match(test_input);
				assertNotNull( 'There should be new message', found );
				$('#channel_back_button', scope).click();
				waitForTransaction( function() {
				$('#channels_back_button', scope).click();
				} );
				} );
				} );
				} );	
				} );
				} );
				} );
				} );
				} );
				} );
               	} );
				
			}
		</script>
		
	</body>
</html>
